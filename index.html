<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Genesys Contact Outbound Call</title>
</head>
<body>
  <h1>Genesys Contact Outbound Call2</h1>
  <button id="callBtn">Call External Contact via Queue</button>
  <div id="status"></div>

  <script>
    // Configuration
    const CLIENT_ID = "c6dcc699-08b2-4484-a165-63dcf225e982";
    const REDIRECT_URI = "https://ishockie.github.io/PopularContacts";
    const GENESYS_ENV = "mypurecloud.de";
    const QUEUE_ID = "355fda98-7d75-4f67-9f15-491acb1a37aa";
    const CONTACT_ID = "791a605b-7948-4e5a-94e6-5b670054a781";

    // Authentication
    let accessToken = null;
    const hashParams = new URLSearchParams(window.location.hash.substring(1));
    if (hashParams.has("access_token")) {
      accessToken = hashParams.get("access_token");
      // Remove the token from the URL
      window.history.replaceState({}, document.title, window.location.pathname);
    }

    // If no access token, redirect to login
    if (!accessToken) {
      redirectToLogin();
    }

    function redirectToLogin() {
      const authUrl = `https://login.${GENESYS_ENV}/oauth/authorize` +
        `?client_id=${encodeURIComponent(CLIENT_ID)}` +
        `&response_type=token` +
        `&redirect_uri=${encodeURIComponent(REDIRECT_URI)}`;
      window.location.replace(authUrl);
    }

    // Update status on the page
    function updateStatus(message) {
      const statusDiv = document.getElementById("status");
      statusDiv.textContent = message;
      // If the message starts with "Error", make text red, else green
      statusDiv.style.color = message.startsWith("Error") ? "red" : "green";
    }

    // Get the current user's ID (the agent ID)
    async function getAgentId() {
      try {
        const response = await fetch(`https://api.${GENESYS_ENV}/api/v2/users/me`, {
          headers: {
            'Authorization': 'Bearer ' + accessToken
          }
        });

        if (!response.ok) {
          const error = await response.json();
          console.error("Agent ID Fetch Error:", error);
          updateStatus("Failed to fetch agent ID. Check console for details.");
          return null;
        }

        const userData = await response.json();
        console.log("Agent Data:", userData);
        return userData.id;

      } catch (err) {
        console.error("Agent ID Network Error:", err);
        updateStatus("Network error fetching agent ID. Check console for details.");
        return null;
      }
    }

    // Get Contact Phone Number
    async function getContactPhoneNumber() {
      try {
        const response = await fetch(
          `https://api.${GENESYS_ENV}/api/v2/externalcontacts/contacts/${CONTACT_ID}`,
          { 
            headers: { 'Authorization': 'Bearer ' + accessToken }
          }
        );

        if (!response.ok) {
          const error = await response.json();
          console.error("Contact Fetch Error:", error);
          updateStatus("Failed to fetch contact details. Check console for details.");
          return null;
        }

        const contactData = await response.json();
        console.log("Contact Data:", contactData);

        // Log addresses array for debugging
        if (contactData.addresses) {
          console.log("Addresses array:", contactData.addresses);
        }
        // Log workPhone if present
        if (contactData.workPhone) {
          console.log("Work Phone object:", contactData.workPhone);
        }

        let phoneNumber = null;

        // 1) Prefer workPhone.e164 if available
        if (contactData.workPhone && contactData.workPhone.e164) {
          phoneNumber = contactData.workPhone.e164;
          console.log("Using contactData.workPhone.e164:", phoneNumber);
        }
        // 2) Otherwise, check addresses array for a phone entry
        else if (Array.isArray(contactData.addresses) && contactData.addresses.length) {
          for (const addr of contactData.addresses) {
            console.log("Inspecting address object:", addr);
            if (
              addr.mediaType === "PHONE" &&
              addr.display &&
              addr.display.startsWith("+")
            ) {
              phoneNumber = addr.display; // or addr.e164 if that exists
              console.log("Using address.display:", phoneNumber);
              break;
            }
          }
        }
        // 3) Fall back to any existing phoneNumber field
        else if (contactData.phoneNumber?.number) {
          phoneNumber = contactData.phoneNumber.number;
          console.log("Using top-level phoneNumber.number:", phoneNumber);
        }
        // 4) Or the older phoneNumbers array
        else if (Array.isArray(contactData.phoneNumbers) && contactData.phoneNumbers.length) {
          for (const p of contactData.phoneNumbers) {
            const candidateNumber = p.value || p.number || "";
            console.log("Examining phone object:", p, " candidateNumber =", candidateNumber);
            if (candidateNumber.startsWith("+")) {
              phoneNumber = candidateNumber;
              console.log("Valid phone number found:", phoneNumber);
              break;
            }
          }
        }
        // 5) If there's a details array
        else if (contactData.details && Array.isArray(contactData.details)) {
          const phoneDetail = contactData.details.find(d => d.field === 'phone');
          if (phoneDetail) {
            console.log("Found a phone detail field:", phoneDetail.value);
            phoneNumber = phoneDetail.value;
          }
        }

        // Validate that the number starts with '+'
        if (!phoneNumber || !phoneNumber.startsWith("+")) {
          console.error("Invalid or missing phone number in contact data:", phoneNumber);
          updateStatus("No valid phone number found for the contact.");
          return null;
        }

        return phoneNumber;

      } catch (err) {
        console.error("Contact Network Error:", err);
        updateStatus("Network error fetching contact details. Check console for details.");
        return null;
      }
    }

    // Place the call, associating the contact
    async function placeContactCall() {
      if (!accessToken) {
        updateStatus("Error: No access token. Please log in.");
        return;
      }

      updateStatus("Starting call process...");

      // 1) Get agent ID
      const agentId = await getAgentId();
      if (!agentId) {
        return; // Error already handled/logged
      }

      // 2) Get contact phone number
      const phoneNumber = await getContactPhoneNumber();
      if (!phoneNumber) {
        // Error already handled/logged
        return;
      }

      // 3) Attempt to place the call
      try {
        console.log("Attempting call with:", {
          phoneNumber,
          contactId: CONTACT_ID,
          queueId: QUEUE_ID,
          userId: agentId
        });

        const response = await fetch(`https://api.${GENESYS_ENV}/api/v2/conversations/calls`, {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + accessToken,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            phoneNumber: phoneNumber,
            contactId: CONTACT_ID,
            queueId: QUEUE_ID,
            userId: agentId
          })
        });

        const data = await response.json();

        if (!response.ok) {
          console.error("API Error:", data);
          updateStatus(`Error: ${data.message || "Failed to place call. Check console for details."}`);
          return;
        }

        console.log("Call initiated:", data);
        updateStatus("Call initiated successfully!");

      } catch (err) {
        console.error("Call Placement Error:", err);
        updateStatus("Error: Failed to place call. Check console for details.");
      }
    }

    // Attach event listener
    document.getElementById("callBtn").addEventListener("click", placeContactCall);

  </script>
</body>
</html>
