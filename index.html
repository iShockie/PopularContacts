<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Genesys Contact Outbound Call</title>
</head>
<body>
  <h1>Genesys Contact Outbound Call</h1>
  <button id="callBtn">Call External Contact via Queueid</button>

  <script>
    // Configuration
    const CLIENT_ID = "c6dcc699-08b2-4484-a165-63dcf225e982";
    const REDIRECT_URI = "https://ishockie.github.io/PopularContacts";
    const GENESYS_ENV = "mypurecloud.de";
    const QUEUE_ID = "355fda98-7d75-4f67-9f15-491acb1a37aa";
    const CONTACT_ID = "791a605b-7948-4e5a-94e6-5b670054a781";

    // Authentication
    let accessToken = null;
    const hashParams = new URLSearchParams(window.location.hash.substring(1));
    if (hashParams.has("access_token")) {
      accessToken = hashParams.get("access_token");
      window.history.replaceState({}, document.title, window.location.pathname);
    }

    // Login redirect
    function redirectToLogin() {
      const authUrl = `https://login.${GENESYS_ENV}/oauth/authorize` +
                      `?client_id=${encodeURIComponent(CLIENT_ID)}` +
                      `&response_type=token` +
                      `&redirect_uri=${encodeURIComponent(REDIRECT_URI)}`;
      window.location.replace(authUrl);
    }

    if (!accessToken) redirectToLogin();

    // Get Agent ID
    async function getAgentId() {
      try {
        const response = await fetch(`https://api.${GENESYS_ENV}/api/v2/users/me`, {
          headers: { 'Authorization': 'Bearer ' + accessToken }
        });
        const userData = await response.json();
        return response.ok ? userData.id : null;
      } catch (err) {
        console.error("Agent ID error:", err);
        return null;
      }
    }

    // Get Contact Phone Number
    async function getContactPhoneNumber() {
      try {
        const response = await fetch(
          `https://api.${GENESYS_ENV}/api/v2/externalcontacts/contacts/${CONTACT_ID}`,
          { headers: { 'Authorization': 'Bearer ' + accessToken } }
        );
        const contactData = await response.json();
        return contactData?.phoneNumber?.number || null;
      } catch (err) {
        console.error("Contact lookup error:", err);
        return null;
      }
    }

    // Place Call with Contact Association
    async function placeContactCall() {
      if (!accessToken) return alert("Authentication required");
      
      const [AGENT_ID, PHONE_NUMBER] = await Promise.all([
        getAgentId(),
        getContactPhoneNumber()
      ]);

      if (!AGENT_ID || !PHONE_NUMBER) {
        return alert("Missing required information");
      }

      try {
        const response = await fetch(`https://api.${GENESYS_ENV}/api/v2/conversations/calls`, {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + accessToken,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            phoneNumber: PHONE_NUMBER,
            contactId: CONTACT_ID,
            queueId: QUEUE_ID,
            userId: AGENT_ID
          })
        });

        const data = await response.json();
        if (!response.ok) throw data;
        
        console.log("Call initiated:", data);
        alert("Outbound call started successfully!");
      } catch (err) {
        console.error("API Error:", err);
        alert(`Error: ${err.message || 'Check console for details'}`);
      }
    }

    document.getElementById("callBtn").addEventListener("click", placeContactCall);
  </script>
</body>
</html>
