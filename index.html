<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Genesys Contact Outbound Call</title>
</head>
<body>
  <h1>Genesys Contact Outbound Call</h1>
  <button id="callBtn">Call External Contact via Queue2</button>
  <div id="status"></div>

  <script>
    // Configuration
    const CLIENT_ID = "c6dcc699-08b2-4484-a165-63dcf225e982";
    const REDIRECT_URI = "https://ishockie.github.io/PopularContacts";
    const GENESYS_ENV = "mypurecloud.de";
    const QUEUE_ID = "355fda98-7d75-4f67-9f15-491acb1a37aa";
    const CONTACT_ID = "791a605b-7948-4e5a-94e6-5b670054a781";

    // Authentication
    let accessToken = null;
    const hashParams = new URLSearchParams(window.location.hash.substring(1));
    if (hashParams.has("access_token")) {
      accessToken = hashParams.get("access_token");
      window.history.replaceState({}, document.title, window.location.pathname);
    }

    // Login redirect
    function redirectToLogin() {
      const authUrl = `https://login.${GENESYS_ENV}/oauth/authorize` +
                      `?client_id=${encodeURIComponent(CLIENT_ID)}` +
                      `&response_type=token` +
                      `&redirect_uri=${encodeURIComponent(REDIRECT_URI)}`;
      window.location.replace(authUrl);
    }

    if (!accessToken) {
      redirectToLogin();
    }

    // Update status on the page
    function updateStatus(message) {
      const statusDiv = document.getElementById("status");
      statusDiv.textContent = message;
      statusDiv.style.color = message.startsWith("Error") ? "red" : "green";
    }

    // Get Agent ID
    async function getAgentId() {
      try {
        const response = await fetch(`https://api.${GENESYS_ENV}/api/v2/users/me`, {
          headers: { 'Authorization': 'Bearer ' + accessToken }
        });

        if (!response.ok) {
          const error = await response.json();
          console.error("Agent ID Fetch Error:", error);
          updateStatus("Failed to fetch agent ID. Check console for details.");
          return null;
        }

        const userData = await response.json();
        console.log("Agent Data:", userData);
        return userData.id;

      } catch (err) {
        console.error("Agent ID Network Error:", err);
        updateStatus("Network error fetching agent ID. Check console for details.");
        return null;
      }
    }

    // Get Contact Phone Number
    async function getContactPhoneNumber() {
      try {
        const response = await fetch(
          `https://api.${GENESYS_ENV}/api/v2/externalcontacts/contacts/${CONTACT_ID}`,
          { headers: { 'Authorization': 'Bearer ' + accessToken } }
        );

        if (!response.ok) {
          const error = await response.json();
          console.error("Contact Fetch Error:", error);
          updateStatus("Failed to fetch contact details. Check console for details.");
          return null;
        }

        const contactData = await response.json();
        console.log("Contact Data:", contactData);

        // Let's print out everything in phoneNumbers if present
        if (contactData.phoneNumbers) {
          console.log("Contact phoneNumbers array:", contactData.phoneNumbers);
        }

        let phoneNumber = null;

        // 1) Check if there's a top-level phoneNumber property (rarely used, but just in case)
        if (contactData.phoneNumber?.number) {
          console.log("Found a top-level phoneNumber property:", contactData.phoneNumber.number);
          phoneNumber = contactData.phoneNumber.number;
        }
        // 2) Check the phoneNumbers array
        else if (Array.isArray(contactData.phoneNumbers) && contactData.phoneNumbers.length > 0) {
          console.log("Iterating through contactData.phoneNumbers...");
          for (const p of contactData.phoneNumbers) {
            // Genesys often stores the number in `value`
            const candidateNumber = p.value || p.number || "";
            console.log("Examining phone object:", p, " candidateNumber =", candidateNumber);
            if (candidateNumber && candidateNumber.startsWith("+")) {
              phoneNumber = candidateNumber;
              console.log("Valid phone number found:", phoneNumber);
              break;
            }
          }
        }
        // 3) Check if there's a 'details' array containing phone data
        else if (contactData.details && Array.isArray(contactData.details)) {
          const phoneDetail = contactData.details.find(d => d.field === 'phone');
          if (phoneDetail) {
            console.log("Found a phone detail field:", phoneDetail.value);
            phoneNumber = phoneDetail.value;
          }
        }

        // Validate the phone number format
        if (!phoneNumber || !phoneNumber.startsWith("+")) {
          console.error("Invalid or missing phone number in contact data:", phoneNumber);
          updateStatus("No valid phone number found for the contact.");
          return null;
        }

        return phoneNumber;

      } catch (err) {
        console.error("Contact Network Error:", err);
        updateStatus("Network error fetching contact details. Check console for details.");
        return null;
      }
    }

    // Place Call with Contact Association
    async function placeContactCall() {
      if (!accessToken) {
        updateStatus("Error: No access token. Please log in.");
        return;
      }

      updateStatus("Starting call process...");

      const agentId = await getAgentId();
      if (!agentId) {
        return; // Error already handled in getAgentId
      }

      const phoneNumber = await getContactPhoneNumber();
      if (!phoneNumber) {
        return; // Error already handled in getContactPhoneNumber
      }

      try {
        console.log("Attempting call with:", {
          phoneNumber,
          contactId: CONTACT_ID,
          queueId: QUEUE_ID,
          userId: agentId
        });

        const response = await fetch(`https://api.${GENESYS_ENV}/api/v2/conversations/calls`, {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + accessToken,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            phoneNumber: phoneNumber,
            contactId: CONTACT_ID,
            queueId: QUEUE_ID,
            userId: agentId
          })
        });

        const data = await response.json();
        if (!response.ok) {
          console.error("API Error:", data);
          updateStatus(`Error: ${data.message || "Failed to place call. Check console for details."}`);
          return;
        }

        console.log("Call initiated:", data);
        updateStatus("Call initiated successfully!");

      } catch (err) {
        console.error("Call Placement Error:", err);
        updateStatus("Error: Failed to place call. Check console for details.");
      }
    }

    // Attach event listener
    document.getElementById("callBtn").addEventListener("click", placeContactCall);
  </script>
</body>
</html>
