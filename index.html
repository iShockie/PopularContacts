<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Genesys Call Example</title>
</head>
<body>
  <h1>Genesys Call Example</h1>
  <!-- The button that places the call -->
  <button id="callBtn">VID Å½VAN3</button>

  <script>
    /***************************************************************
     * 1) Configure These Variables
     ***************************************************************/
    const CLIENT_ID = "c6dcc699-08b2-4484-a165-63dcf225e982";            // e.g., "abc12345-1234-abcd-5678-0123456789ab"
    const REDIRECT_URI = "https://ishockie.github.io/PopularContacts";   // e.g., "https://mydomain.com/genesys-calls.html"
    const GENESYS_ENV = "mypurecloud.de";                                // or "mypurecloud.ie", "mypurecloud.de", etc.
    const QUEUE_ID = "355fda98-7d75-4f67-9f15-491acb1a37aa";            // Queue ID for routing calls

    /***************************************************************
     * 2) Parse Access Token From URL (Implicit Flow)
     *    Check if we were redirected back with an #access_token
     ***************************************************************/
    let accessToken = null;

    // Example: URL might look like:
    // https://mydomain.com/genesys-calls.html#access_token=xyz123&token_type=bearer&expires_in=86400
    const hashParams = new URLSearchParams(window.location.hash.substring(1));
    if (hashParams.has("access_token")) {
      accessToken = hashParams.get("access_token");
      console.log("Got token from URL hash:", accessToken);

      // (Optional) Clean up the URL to remove the token fragment:
      window.history.replaceState({}, document.title, window.location.pathname);
    }

    /***************************************************************
     * 3) If No Token, Redirect to Genesys Cloud /authorize
     ***************************************************************/
    function redirectToLogin() {
      // Build the Genesys Cloud authorize URL
      // For Implicit flow: response_type=token
      const authUrl = `https://login.${GENESYS_ENV}/oauth/authorize` +
                      `?client_id=${encodeURIComponent(CLIENT_ID)}` +
                      `&response_type=token` +
                      `&redirect_uri=${encodeURIComponent(REDIRECT_URI)}` +
                      `&force_login=false`; // set to true to force login screen

      // Redirect the browser to Genesys Cloud's login/authorize
      window.location.replace(authUrl);
    }

    if (!accessToken) {
      // No token in URL => we need to authenticate
      redirectToLogin();
    }

    /***************************************************************
     * 4) Check OAuth Client Permissions
     ***************************************************************/
    async function checkPermissions() {
      try {
        const response = await fetch(`https://api.${GENESYS_ENV}/api/v2/oauth/clients/${CLIENT_ID}`, {
          method: 'GET',
          headers: {
            'Authorization': 'Bearer ' + accessToken
          }
        });

        if (!response.ok) {
          const errorData = await response.json();
          console.error("Error fetching OAuth client details:", errorData);
          return false;
        }

        const clientData = await response.json();
        console.log("OAuth Client Details:", clientData);

        // Check if the required permissions are present
        const requiredPermissions = [
          "conversations:call:add",
          "routing:queue:add",
          "users:routingstatus:view",
          "telephony:plugin:all"
        ];

        const hasPermissions = requiredPermissions.every(perm => 
          clientData.roles.some(role => role.permissions.includes(perm))
        );

        if (!hasPermissions) {
          console.error("Missing required permissions.");
          return false;
        }

        return true;
      } catch (err) {
        console.error("Fetch error:", err);
        return false;
      }
    }

    /***************************************************************
     * 5) Place a Call Using the Genesys Cloud API via a Queue
     ***************************************************************/
    async function placeCall(phoneNumber) {
      if (!accessToken) {
        alert("No valid access token. Please log in.");
        return;
      }

      try {
        const response = await fetch(`https://api.${GENESYS_ENV}/api/v2/conversations/calls`, {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + accessToken,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            phoneNumber: phoneNumber, // External phone number
            queueId: QUEUE_ID, // Queue ID
            callbackUserName: "Web Caller", // Optional: Name for the call log
            callbackNumbers: [phoneNumber], // Optional: Callback numbers
            data: {
              customData: "Call from Web Interface" // Optional: Additional data
            }
          })
        });

        const responseData = await response.json();
        console.log("API Response:", responseData);

        if (!response.ok) {
          console.error("Error placing call:", responseData);
          alert("Error placing call. Check console for details.");
          return;
        }

        console.log("Call initiated via queue:", responseData);
        alert("Call initiated successfully via queue.");
      } catch (err) {
        console.error("Fetch error:", err);
        alert("Error placing call. Check console for details.");
      }
    }

    /***************************************************************
     * 6) Initialize the Script
     ***************************************************************/
    async function init() {
      // Check permissions before allowing the call
      const hasPermissions = await checkPermissions();
      if (!hasPermissions) {
        alert("Missing required permissions. Please check your OAuth client configuration.");
        return;
      }

      // Attach event to the button
      document.getElementById("callBtn").addEventListener("click", () => {
        placeCall("+38640132345"); // Replace with the desired phone number
      });
    }

    // Initialize the script
    init();
  </script>
</body>
</html>
