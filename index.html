<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Genesys Cloud Outbound Call Integration</title>
</head>
<body>
  <!-- Button to trigger the outbound call -->
  <button id="vidzvan">Vid ZÅ½van</button>

  <script>
    // -----------------------------
    // OAuth Configuration & Handling
    // -----------------------------
    const clientId = 'c6dcc699-08b2-4484-a165-63dcf225e982'; // Your OAuth client ID
    const redirectUriValue = "https://ishockie.github.io/PopularContacts/"; // Must exactly match your configured URI
    const redirectUri = encodeURIComponent(redirectUriValue);
    const state = "abc123"; // Optional state parameter
    const oauthEndpoint = "https://login.mypurecloud.de/oauth/authorize";

    // Construct the OAuth URL (no explicit scope parameter since implicit uses user scopes)
    const authUrl = `${oauthEndpoint}?response_type=token&client_id=${clientId}&redirect_uri=${redirectUri}&state=${state}`;

    // Extract URL parameters from the hash fragment
    function getParamsFromHash() {
      const hash = window.location.hash.substring(1);
      console.log("URL hash:", hash);
      return new URLSearchParams(hash);
    }

    // Handle OAuth redirect and extract the access token (or log any OAuth errors)
    function handleOAuthRedirect() {
      const params = getParamsFromHash();
      if (params.has('error')) {
        console.error("OAuth Error:", params.get("error"), params.get("error_description"));
        return null;
      }
      return params.get('access_token');
    }

    // Attempt to obtain the access token from the URL hash or from localStorage
    let accessToken = handleOAuthRedirect();
    if (accessToken) {
      localStorage.setItem("genesys_access_token", accessToken);
      console.log("Access token obtained from URL:", accessToken);
      window.location.hash = "";
    } else {
      accessToken = localStorage.getItem("genesys_access_token");
      console.log("Access token from localStorage:", accessToken);
    }

    if (!accessToken) {
      console.error("No access token available. Redirecting to OAuth URL:", authUrl);
      window.location.href = authUrl;
    } else {
      console.log("Access token exists. Proceeding with app functionality.");
    }
    console.log("LocalStorage contents:", localStorage);

    // -----------------------------
    // External Contact & Outbound Call Configuration
    // -----------------------------
    const externalContactId = "791a605b-7948-4e5a-94e6-5b670054a781";
    const callFromQueueId = "477cbe0e-1865-4b06-933b-e81961c3c827"; // Outbound call queue ID
    const callerId = "+38628216565"; // Outbound caller ID

    // -----------------------------
    // Functions
    // -----------------------------

    // Fetch the external contact details from Genesys Cloud
    function fetchExternalContact() {
      const url = `https://api.mypurecloud.de/api/v2/externalcontacts/contacts/${externalContactId}`;
      console.log("Fetching external contact from:", url);
      return fetch(url, {
        method: "GET",
        headers: {
          "Authorization": "Bearer " + accessToken,
          "Content-Type": "application/json"
        }
      })
      .then(response => {
        console.log("External contact fetch status:", response.status);
        if (!response.ok) {
          return response.text().then(text => { throw new Error(text); });
        }
        return response.json();
      });
    }

    // Trigger the outbound call using the external contact's work phone number
    function triggerCallWithPhone(phoneNumber) {
      // Genesys Cloud API endpoint for placing a call
      const apiUrl = "https://api.mypurecloud.de/api/v2/conversations/calls";

      // Prepare the payload.
      // We include both minimal parameters and a non-empty "destinations" array.
      const payload = {
        callFromQueueId: callFromQueueId,
        phoneNumber: phoneNumber, // Minimal parameter (the destination number)
        callerId: callerId,
        externalContactId: externalContactId, // Reference to the external contact
        destinations: [
          {
            address: phoneNumber, // Destination number inside destinations array
            addressType: "phone"
          }
        ]
      };

      console.log("Making outbound call API request with payload:", payload);

      return fetch(apiUrl, {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + accessToken,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(payload)
      })
      .then(response => {
        console.log("Outbound call API response status:", response.status);
        if (!response.ok) {
          return response.text().then(text => { throw new Error(text); });
        }
        return response.json();
      });
    }

    // Main function called on button click to get the external contact's phone number and place the call
    function triggerCall() {
      console.log("Triggering call for external contact:", externalContactId);
      fetchExternalContact()
      .then(contactData => {
        console.log("External contact data received:", contactData);
        // Always use the workPhone.e164 as the primary phone number.
        const phoneNumber = (contactData.workPhone && contactData.workPhone.e164) || null;
        if (!phoneNumber) {
          throw new Error("No work phone number found for external contact " + externalContactId);
        }
        console.log("Using work phone number:", phoneNumber, "for outbound call.");
        return triggerCallWithPhone(phoneNumber);
      })
      .then(callData => {
        console.log("Call triggered successfully:", callData);
      })
      .catch(error => {
        console.error("Error triggering call:", error);
      });
    }

    // -----------------------------
    // Event Listener
    // -----------------------------
    document.getElementById("vidzvan").addEventListener("click", triggerCall);
  </script>
</body>
</html>
