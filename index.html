<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Genesys Cloud Outbound Call Integration</title>
</head>
<body>
  <!-- Button that will trigger the outbound call -->
  <button id="vidzvan">Vid Å½van</button>

  <script>
    // Helper: Extract access token from URL fragment (if present)
    function getAccessTokenFromHash() {
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      return params.get('access_token');
    }

    // Check for access token in URL or in localStorage
    let accessToken = getAccessTokenFromHash();
    if (accessToken) {
      localStorage.setItem('genesys_access_token', accessToken);
      // Optionally, remove token details from URL for cleanliness
      window.location.hash = '';
    } else {
      accessToken = localStorage.getItem('genesys_access_token');
    }

    // If no access token, redirect to Genesys Cloud OAuth authorization endpoint
    if (!accessToken) {
      const clientId = 'YOUR_CLIENT_ID'; // Replace with your OAuth client ID
      const redirectUri = encodeURIComponent(window.location.href);
      // Adjust the scope string as required (e.g., conversation:write)
      const scope = encodeURIComponent('conversation:write');
      const authUrl = `https://login.mypurecloud.de/oauth/authorize?response_type=token&client_id=${clientId}&redirect_uri=${redirectUri}&scope=${scope}`;
      window.location.href = authUrl;
    }

    // Add click handler for the button
    document.getElementById('vidzvan').addEventListener('click', triggerCall);

    // Function that triggers the outbound call
    function triggerCall() {
      const token = localStorage.getItem('genesys_access_token');
      if (!token) {
        console.error("No access token available.");
        return;
      }

      // Genesys Cloud API endpoint for the DE (Frankfurt) region.
      // (Double-check the endpoint for your integration; this is typically the DE endpoint.)
      const apiUrl = 'https://api.mypurecloud.de/api/v2/conversations/calls';

      // Prepare the payload.
      // Depending on your Genesys Cloud configuration and API version, the payload may require
      // additional fields (like a caller ID, callFrom, etc.). Consult the API docs.
      const payload = {
        queueId: "477cbe0e-1865-4b06-933b-e81961c3c827",  // Your outbound call queue ID
        phoneNumber: "+38640132345"                         // The destination phone number
      };

      // Make the POST request using the Fetch API
      fetch(apiUrl, {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + token,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      })
      .then(response => {
        if (!response.ok) {
          return response.text().then(text => { throw new Error(text) });
        }
        return response.json();
      })
      .then(data => {
        console.log("Call triggered successfully:", data);
      })
      .catch(error => {
        console.error("Error triggering call:", error);
      });
    }
  </script>
</body>
</html>
