<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Genesys Cloud Call Application</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
        }
        #call-button {
            padding: 10px 20px;
            font-size: 16px;
            margin: 10px 0;
        }
        #status {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            background-color: #f9f9f9;
            max-width: 600px;
            overflow-y: auto;
            max-height: 300px;
        }
    </style>
</head>
<body>
    <h1>Genesys Cloud Call Application</h1>
    <button id="call-button" disabled>Place Call</button>

    <div id="status"></div>

    <script>
        (function() {
            // Configuration - Replace these with your actual values
            const CLIENT_ID = 'c6dcc699-08b2-4484-a165-63dcf225e982'; // Replace with your Genesys Cloud OAuth Client ID
            const REDIRECT_URI = 'https://ishockie.github.io/PopularContacts/'; // e.g., 'https://yourdomain.com/callback'
            const AUTHORIZATION_URL = 'https://login.mypurecloud.de/oauth/authorize';
            const API_BASE_URL = 'https://api.mypurecloud.de/api/v2';
            const CALL_QUEUE_ID = '477cbe0e-1865-4b06-933b-e81961c3c827'; // Your Queue ID
            const TARGET_PHONE_NUMBER = '+38640132345'; // The number to call

            // Elements
            const callButton = document.getElementById('call-button');
            const statusDiv = document.getElementById('status');

            // Utility function to parse URL hash parameters
            function parseHashParams(hash) {
                const params = {};
                const regex = /([^&=]+)=([^&]*)/g;
                let m;
                while ((m = regex.exec(hash))) {
                    params[decodeURIComponent(m[1])] = decodeURIComponent(m[2]);
                }
                return params;
            }

            // Function to initiate OAuth implicit grant flow
            function initiateLogin() {
                const authUrl = `${AUTHORIZATION_URL}?response_type=token&client_id=${encodeURIComponent(CLIENT_ID)}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&state=${encodeURIComponent(generateState())}&scope=conversations:edit%20conversations:read`;
                window.location = authUrl;
            }

            // Function to generate a random state parameter for security
            function generateState(length = 16) {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
                let result = '';
                for (let i = 0; i < length; i++) {
                    result += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return result;
            }

            // Function to display status messages
            function updateStatus(message) {
                const p = document.createElement('p');
                p.textContent = message;
                statusDiv.appendChild(p);
                // Auto-scroll to the bottom
                statusDiv.scrollTop = statusDiv.scrollHeight;
            }

            // Function to place a call using the Conversations API
            async function placeCall(accessToken) {
                const url = `${API_BASE_URL}/conversations/calls`;
                const payload = {
                    phoneNumber: TARGET_PHONE_NUMBER,
                    queueId: CALL_QUEUE_ID,
                    callerId: 'YOUR_CALLER_ID', // Optional: Set your desired caller ID
                    recording: false, // Optional: Enable call recording if needed
                    // Additional parameters can be added here as per API requirements
                };

                try {
                    updateStatus('Placing call...');
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${accessToken}`
                        },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const data = await response.json();
                        updateStatus(`Call placed successfully. Conversation ID: ${data.id}`);
                    } else {
                        const errorData = await response.json();
                        updateStatus(`Error placing call: ${errorData.message || response.statusText}`);
                    }
                } catch (error) {
                    updateStatus(`Network error: ${error.message}`);
                }
            }

            // Event listener for call button
            callButton.addEventListener('click', () => {
                if (window.accessToken) {
                    placeCall(window.accessToken);
                } else {
                    updateStatus('Access token is missing.');
                }
            });

            // On page load, handle authentication
            window.onload = function() {
                if (window.location.hash) {
                    const params = parseHashParams(window.location.hash.substring(1));
                    if (params.access_token) {
                        window.accessToken = params.access_token;
                        updateStatus('Authentication successful.');
                        callButton.disabled = false;

                        // Optionally, clear the URL hash for cleanliness
                        window.history.replaceState({}, document.title, window.location.pathname);
                    } else if (params.error) {
                        updateStatus(`Authentication error: ${params.error_description || params.error}`);
                    }
                } else {
                    // No access token present, initiate login automatically
                    initiateLogin();
                }
            };
        })();
    </script>
</body>
</html>
