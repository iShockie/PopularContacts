<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Genesys Cloud Outbound Call Integration</title>
</head>
<body>
  <!-- Button to trigger the outbound call -->
  <button id="vidzvan">Vid Å½van</button>

  <script>
    // Replace with your actual OAuth client ID from Genesys Cloud
    const clientId = 'c6dcc699-08b2-4484-a165-63dcf225e982';
    // Hard-coded redirect URI; ensure this exactly matches the one registered in Genesys Cloud
    const redirectUri = encodeURIComponent("https://ishockie.github.io/PopularContacts");
    // Set the required OAuth scope; adjust if needed
    const scope = encodeURIComponent("conversation:write");
    // Genesys Cloud DE (Frankfurt) OAuth endpoint
    const oauthEndpoint = "https://login.mypurecloud.de/oauth/authorize";

    // Function to extract the access token from the URL fragment after OAuth redirect
    function getAccessTokenFromHash() {
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      return params.get('access_token');
    }

    // Try to get the access token from the URL hash or from localStorage
    let accessToken = getAccessTokenFromHash();
    if (accessToken) {
      // Store the token in localStorage and clear the hash for cleanliness
      localStorage.setItem("genesys_access_token", accessToken);
      window.location.hash = "";
      // Clear the redirect flag since we now have a token
      localStorage.removeItem("oauthAttempted");
    } else {
      // If not found in the URL, try localStorage
      accessToken = localStorage.getItem("genesys_access_token");
    }

    // Construct the full OAuth URL
    const authUrl = `${oauthEndpoint}?response_type=token&client_id=${clientId}&redirect_uri=${redirectUri}&scope=${scope}`;

    // If no access token is available, check if we've already attempted to get one
    if (!accessToken) {
      if (!localStorage.getItem('oauthAttempted')) {
        // Set a flag to indicate an OAuth attempt has been made, then redirect
        localStorage.setItem('oauthAttempted', 'true');
        window.location.href = authUrl;
      } else {
        // If the flag is already set, stop redirecting and log an error
        console.error("OAuth redirect loop detected. Check your configuration.");
      }
    }

    // Add click event listener to the button to trigger the outbound call
    document.getElementById("vidzvan").addEventListener("click", triggerCall);

    // Function to trigger the outbound call via the Genesys Cloud API
    function triggerCall() {
      const token = localStorage.getItem("genesys_access_token");
      if (!token) {
        console.error("No access token available.");
        return;
      }
      
      // Genesys Cloud API endpoint for DE (Frankfurt)
      const apiUrl = "https://api.mypurecloud.de/api/v2/conversations/calls";
      
      // Prepare the payload for the outbound call
      const payload = {
        queueId: "477cbe0e-1865-4b06-933b-e81961c3c827",  // Your outbound call queue ID
        phoneNumber: "+38640132345"                         // The destination phone number
      };

      // Make the API call using Fetch
      fetch(apiUrl, {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + token,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(payload)
      })
      .then(response => {
        if (!response.ok) {
          return response.text().then(text => { throw new Error(text) });
        }
        return response.json();
      })
      .then(data => {
        console.log("Call triggered successfully:", data);
      })
      .catch(error => {
        console.error("Error triggering call:", error);
      });
    }
  </script>
</body>
</html>
